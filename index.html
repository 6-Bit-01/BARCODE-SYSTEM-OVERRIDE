<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BARCODE: System Override</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            background: #000;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            min-width: 100vw;
            min-height: 100vh;
            max-width: 100vw;
            max-height: 100vh;
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            font-family: 'Orbitron', monospace;
        }
        
        /* CRT Effect Overlay */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 255, 0.03) 0px,
                transparent 1px,
                transparent 2px,
                rgba(255, 0, 255, 0.03) 3px
            );
            pointer-events: none;
            z-index: 1000;
        }
        
        /* Scanline effect */
        @keyframes scanlines {
            0% { background-position: 0 0; }
            100% { background-position: 0 10px; }
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        /* Game UI overlay - positioned over canvas */
        .topbar {
            background: linear-gradient(135deg, rgba(0,255,255,0.9), rgba(255,0,255,0.9));
            border: 4px solid #000000;
            border-bottom: none;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
            height: 60px;
        }
        
        .hint {
            background: linear-gradient(135deg, rgba(16, 18, 24, 0.95), rgba(32, 36, 48, 0.95));
            border: 4px solid #000000;
            border-top: none;
            padding: 12px;
            text-align: center;
            color: #ff00ff;
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
            height: 60px;
        }
        
        /* Canvas container - fills remaining space */
        #gameCanvas {
            display: block;
            flex: 1;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a, #1a0a1a);
            border: 2px solid rgba(0,255,255,0.3);
            border-top: none;
            border-bottom: none;
            position: relative;
        }
        
        .topbar {
            background: linear-gradient(135deg, rgba(0,255,255,0.9), rgba(255,0,255,0.9));
            border: 4px solid #000000;
            border-bottom: none;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.8);
        }
        
        .topbar::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,255,0.2), transparent);
            animation: glitch 3s infinite;
        }
        
        @keyframes glitch {
            0% { left: -100%; }
            20% { left: -100%; }
            40% { left: 100%; }
            100% { left: 100%; }
        }
        
        .topbar span {
            color: #00ffff;
            font-weight: 900;
            text-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff;
            position: relative;
            z-index: 1;
        }
        
        .health-bar {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .health-segment {
            width: 30px;
            height: 20px;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            border: 1px solid #00ffff;
            box-shadow: 0 0 5px #00ffff;
            transition: all 0.3s;
        }
        
        .health-segment.empty {
            background: rgba(255,0,255,0.1);
            border-color: rgba(0,255,255,0.2);
            box-shadow: none;
        }
        
        .game-container {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 0;
        }
        
        #gameCanvas {
            display: none;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a, #1a0a1a);
            border: 2px solid rgba(0,255,255,0.3);
            border-top: none;
            border-bottom: none;
            position: relative;
        }
        
        .hint {
            background: linear-gradient(135deg, rgba(16, 18, 24, 0.95), rgba(32, 36, 48, 0.95));
            border: 4px solid #000000;
            border-top: none;
            padding: 12px;
            text-align: center;
            color: #ff00ff;
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            display: none;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.8);
        }
        
        .hint::before {
            content: ">";
            color: #00ffff;
            margin-right: 8px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Rhythm Indicator */
        .rhythm-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border: 2px solid #ff00ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,0,255,0.1);
            z-index: 100;
        }
        
        .rhythm-pulse {
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ff00ff, #00ffff);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Start Button Overlay - FULL SCREEN INTRO */
        .start-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: radial-gradient(ellipse at center, rgba(0,20,40,0.95) 0%, rgba(0,0,0,0.98) 100%);
            display: flex !important;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.8s ease-out;
            transform: scale(1) !important;
            overflow: hidden;
        }
        
        /* Force start overlay content to be normal sized */
        .start-overlay .game-title {
            font-size: 8vw !important;
            margin-bottom: 1vw !important;
            line-height: 0.9 !important;
        }
        
        .start-overlay .game-subtitle {
            font-size: 2.5vw !important;
            margin-bottom: 4vw !important;
            font-family: 'Share Tech Mono', monospace !important;
            letter-spacing: 0.4vw !important;
            font-weight: 400 !important;
            text-transform: uppercase !important;
        }
        
        .start-overlay .start-button {
            font-size: 2vw !important;
            padding: 1.5vw 4vw !important;
            min-width: 280px !important;
            min-height: 80px !important;
        }
        
        .start-overlay .instructions {
            font-size: 1.2vw !important;
            padding: 1.5vw 2.5vw !important;
            margin-top: 3vw !important;
        }
        
        /* Ensure start overlay content is properly sized */
        .start-overlay * {
            box-sizing: border-box;
        }
        
        .start-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .game-title {
            font-size: 12vw;
            font-weight: 900;
            color: #00ffff;
            text-shadow: 
                0 0 20px #00ffff, 
                0 0 40px #00ffff,
                0 0 60px #00ffff,
                0 0 80px #ff00ff;
            margin-bottom: 3vw;
            text-align: center;
            letter-spacing: 0.5vw;
            animation: titleGlow 3s ease-in-out infinite alternate;
            background: linear-gradient(45deg, #00ffff, #ff00ff, #00ffff);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleGlow 3s ease-in-out infinite alternate, gradientShift 4s ease-in-out infinite;
            min-height: auto;
            line-height: 1.1;
        }
        
        @keyframes titleGlow {
            0% { 
                text-shadow: 
                    0 0 20px #00ffff, 
                    0 0 40px #00ffff, 
                    0 0 60px #ff00ff;
            }
            100% { 
                text-shadow: 
                    0 0 30px #00ffff, 
                    0 0 60px #00ffff, 
                    0 0 80px #ff00ff, 
                    0 0 100px #00ffff;
            }
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .game-subtitle {
            font-size: 4vw;
            color: #ff00ff;
            text-shadow: 0 0 20px #ff00ff;
            margin-bottom: 8vw;
            font-family: 'Share Tech Mono', monospace;
            letter-spacing: 0.3vw;
            opacity: 0.9;
        }
        
        .start-button {
            background: linear-gradient(135deg, #00ffff, #ff00ff);
            border: none;
            color: #000;
            font-size: 3.5vw;
            font-weight: 700;
            padding: 3vw 8vw;
            text-transform: uppercase;
            letter-spacing: 0.3vw;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 
                0 0 30px rgba(0, 255, 255, 0.5),
                0 10px 40px rgba(255, 0, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Orbitron', monospace;
            position: relative;
            overflow: hidden;
            min-width: 350px;
            min-height: 100px;
        }
        
        .start-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.6s ease;
        }
        
        .start-button:hover::before {
            left: 100%;
        }
        
        .start-button:hover {
            transform: scale(1.08) translateY(-2px);
            box-shadow: 
                0 0 50px rgba(0, 255, 255, 0.8),
                0 15px 50px rgba(255, 0, 255, 0.5);
        }
        
        .start-button:active {
            transform: scale(0.98);
        }
        
        .instructions {
            margin-top: 5vw;
            color: #888;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.6vw;
            text-align: center;
            line-height: 1.8;
            background: rgba(0,0,0,0.5);
            padding: 2.5vw 4vw;
            border: 1px solid rgba(0,255,255,0.2);
            border-radius: 8px;
        }
        
        .instructions-line {
            margin: 0.5vw 0;
            color: #aaa;
        }
        
        .key, .key * {
            color: #00ffff !important;
            font-weight: bold !important;
            text-shadow: none !important;
            background: transparent !important;
            box-shadow: none !important;
            filter: none !important;
            text-decoration: none !important;
            outline: none !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        /* Loading indicator */
        .loading-indicator {
            position: absolute;
            bottom: 10vh;
            left: 50%;
            transform: translateX(-50%);
            color: #ff00ff;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1vw;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .loading-indicator.visible {
            opacity: 1;
        }
        
        /* Responsive design */
        @media (max-width: 1200px) {
            .game-title {
                font-size: 10vw;
            }
            .game-subtitle {
                font-size: 4vw;
            }
            .start-button {
                font-size: 3vw;
                padding: 2.5vw 7vw;
            }
            .instructions {
                font-size: 1.5vw;
            }
        }
        
        @media (max-width: 768px) {
            .game-title {
                font-size: 12vw;
            }
            .game-subtitle {
                font-size: 5vw;
            }
            .start-button {
                font-size: 4vw;
                padding: 3vw 8vw;
            }
            .instructions {
                font-size: 2vw;
                padding: 3vw 5vw;
            }
        }
    </style>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- FULL SCREEN INTRO OVERLAY -->
    <div id="startOverlay" class="start-overlay" style="
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background: radial-gradient(ellipse at center, rgba(0,20,40,0.95) 0%, rgba(0,0,0,0.98) 100%) !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
        z-index: 2000 !important;
        transform: scale(1) !important;
        margin: 0 !important;
        padding: 0 !important;
    ">
        <h1 class="game-title">BARCODE</h1>
        <div class="game-subtitle">System Override</div>
        <button id="startButton" class="start-button">START SYSTEM</button>
        <div class="instructions">
            <div class="instructions-line"><span class="key">Arrow Keys</span> - Move | <span class="key">Space</span> - Action</div>
            <div class="instructions-line"><span class="key">R</span> - Rhythm Attack | <span class="key">H</span> - Hack Terminal</div>
            <div class="instructions-line"><span class="key">Shift+F</span> - Fullscreen</div>
        </div>
        <div id="loadingIndicator" class="loading-indicator">INITIALIZING SYSTEM...</div>
    </div>

    <!-- Game Container with Flex Layout -->
    <div class="game-container">
        <!-- Game UI Top Bar -->
        <div class="topbar" style="display: none;">
            <span style="color: #00ffff;">BARCODE: System Override</span>
            <div class="health-bar">
                <div class="health-segment"></div>
                <div class="health-segment"></div>
                <div class="health-segment"></div>
            </div>
        </div>
        
        <!-- Game Canvas - Fills remaining space -->
        <canvas id="gameCanvas" width="1920" height="1080" style="display: none;"></canvas>
        
        <!-- Game UI Bottom Hint -->
        <div class="hint" style="display: none;">Arrow Keys: Move | Space: Action | R: Rhythm Attack | H: Hack Terminal</div>
    </div>

    <!-- MakkoEngine for sprite animations -->
    <script src="/lib/MakkoEngine.min.js"></script>
    
    <!-- Core Game Systems -->
    <script src="src/utils/math.js"></script>
    <script src="src/core/fullscreen.js"></script>
    <script src="src/core/input.js"></script>
    <script src="src/engine/audio.js"></script>
    <script src="src/engine/particles.js"></script>
    <script src="src/engine/renderer.js"></script>
    <script src="src/engine/parallax.js"></script>
    <script src="src/engine/spaceships.js"></script>
    <script src="src/engine/lore.js"></script>
    <script src="src/engine/jammer-indicator.js"></script>
    <script src="src/game/objectives.js"></script>
    <script src="src/engine/cutscene.js"></script>
    <script src="src/core/loop.js"></script>

    <!-- Game Systems -->
    <script src="src/game/player.js"></script>
    <script src="src/game/enemies.js"></script>
    <script src="src/game/hacking.js"></script>
    <script src="src/game/broadcast-jammer.js"></script>
    <script src="src/game/rhythm.js"></script>
    <script src="src/game/tutorial.js"></script>
    <script src="src/game/post-tutorial-objectives.js"></script>
    <script src="src/game/lost-data.js"></script>
    <script src="src/game/sector1-progression.js"></script>

    <!-- Main Game -->
    <script src="src/game/main.js"></script>

    <script>
        // ========================================
        // GLOBAL ERROR HANDLING
        // ========================================
        
        // Catch unhandled promise rejections at the page level
        window.addEventListener('unhandledrejection', function(event) {
            // Filter out expected permission and fullscreen errors
            if (event.reason && event.reason.message) {
                if (event.reason.message.includes('permission') || 
                    event.reason.message.includes('Permission') ||
                    event.reason.message.includes('fullscreen') ||
                    event.reason.message.includes('Fullscreen')) {
                    console.log('Expected permission/fullscreen rejection:', event.reason.message);
                    event.preventDefault();
                    return;
                }
                
                // Handle empty promise rejections
                if (!event.reason || Object.keys(event.reason).length === 0) {
                    console.log('Empty promise rejection filtered - ignoring');
                    event.preventDefault();
                    return;
                }
            }
            
            console.error('[PageHandler] Unhandled promise rejection:', {
                reason: event.reason,
                stack: event.reason?.stack || 'No stack available'
            });
            
            // Prevent default browser error logging
            event.preventDefault();
        });
        
        // ========================================
        // FULLSCREEN MANAGEMENT
        // ========================================
        
        // REMOVED: Auto-enter fullscreen on first user interaction
        // Users should control fullscreen manually with Shift+F to prevent unwanted fullscreen behavior
        
        // ========================================
        // INTRO SCENE MANAGEMENT
        // ========================================
        
        let gameInitialized = false;
        
        // START BUTTON HANDLER - STARTS GAME IN FULLSCREEN
        document.getElementById('startButton').addEventListener('click', async function() {
            console.log('=== START BUTTON CLICKED - INITIALIZING GAME ===');
            
            // STEP 0: Enter fullscreen immediately (using new fullscreen manager)
            console.log('Step 0: Entering fullscreen mode...');
            if (window.fullscreenManager) {
                window.fullscreenManager.enter().catch(err => {
                    // Silently handle permissions check failures
                    if (err.name === 'TypeError' && err.message && err.message.includes('Permissions check failed')) {
                        return;
                    }
                    console.log('ðŸŽ® Fullscreen request declined on start:', err.message);
                });
            }
            
            // Small delay to ensure fullscreen is active
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Disable button to prevent multiple clicks
            this.disabled = true;
            this.textContent = 'INITIALIZING...';
            
            // Show loading indicator
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.add('visible');
            
            try {
                // STEP 1: Initialize all game systems
                console.log('Step 1: Initializing game systems...');
                
                // Initialize sprite system
                await window.initSprites();
                
                // Initialize audio system
                await window.initAudio();
                
                // Initialize parallax background
                console.log('Initializing parallax background...');
                window.initParallax();
                console.log('âœ“ Parallax background initialized');
                
                // Initialize space ship system
                console.log('Initializing space ship system...');
                window.initSpaceShips();
                console.log('âœ“ Space ship system initialized');
                
                // Initialize lore system
                console.log('Initializing lore system...');
                window.initLore();
                console.log('âœ“ Lore system initialized');
                
                // ðŸ”¥ðŸ”¥ðŸ”¥ FORCE INIT LOST DATA SYSTEM
                console.log('ðŸ”¥ðŸ”¥ðŸ”¥ FORCE INITIALIZING LOST DATA SYSTEM...');
                try {
                    window.initLostData(null); // Force init without player
                    console.log('âœ…âœ…âœ… LOST DATA SYSTEM FORCE INITIALIZED!!!');
                    
                    // REMOVED: Forced first fragment spawn at player position
                    // Let the natural spawn system handle the first fragment with proper randomization
                    console.log('ðŸŽ² First fragment will spawn naturally with random positioning');
                } catch (error) {
                    console.error('âŒâŒâŒ FAILED TO FORCE INIT LOST DATA:', error);
                }
                
                // Initialize cutscene system
                console.log('Initializing cutscene system...');
                window.initCutscene();
                console.log('âœ“ Cutscene system initialized');
                
                // Initialize broadcast jammer system
                console.log('Initializing broadcast jammer system...');
                if (window.BroadcastJammerSystem && typeof window.BroadcastJammerSystem.init === 'function') {
                    window.BroadcastJammerSystem.init();
                    console.log('âœ“ Broadcast jammer system initialized');
                } else {
                    console.warn('âš ï¸ Broadcast jammer system not available');
                }
                
                // Do NOT start rhythm system - wait until game starts
                console.log('Rhythm system waiting - will start with game');
                
                // STEP 2: Hide start screen interface
                console.log('Step 2: Hiding start interface...');
                document.getElementById('startOverlay').classList.add('hidden');
                
                // Hide game interface (canvas) during cutscene - cutscene will show images
                document.getElementById('gameCanvas').style.display = 'none';
                
                // STEP 3: Play intro cutscene BEFORE starting the game
                console.log('Step 3: Playing intro cutscene...');
                try {
                    if (window.cutsceneSystem) {
                        await window.cutsceneSystem.start();
                        console.log('âœ“ Intro cutscene completed');
                    }
                } catch (error) {
                    console.warn('âš ï¸ Cutscene failed, continuing to game:', error?.message || error);
                }
                
                // STEP 4: Show full game interface after cutscene
                console.log('Step 4: Showing complete game interface...');
                document.getElementById('gameCanvas').style.display = 'block';
                document.querySelector('.topbar').style.display = 'flex';
                document.querySelector('.hint').style.display = 'block';
                
                // STEP 5: Initialize and start tutorial
                console.log('Step 5: Starting tutorial system...');
                if (window.tutorialSystem) {
                    if (typeof window.tutorialSystem.startTutorial === 'function') {
                        window.tutorialSystem.startTutorial();
                    }
                }
                
                // STEP 6: Start the game (AFTER cutscene)
                console.log('Step 6: Starting game...');
                if (typeof window.startGame === 'function') {
                    window.startGame();
                }
                
                // Hide loading indicator
                loadingIndicator.classList.remove('visible');
                
                gameInitialized = true;
                
                console.log('âœ“ GAME STARTED SUCCESSFULLY IN FULLSCREEN!');
                
            } catch (error) {
                console.error('âŒ FATAL ERROR INITIALIZING GAME:', error);
                
                // Show error state
                this.textContent = 'ERROR - RETRY';
                this.disabled = false;
                loadingIndicator.textContent = 'INITIALIZATION FAILED';
                loadingIndicator.style.color = '#ff0000';
                
                // Allow retry after delay
                setTimeout(() => {
                    this.textContent = 'START SYSTEM';
                    loadingIndicator.classList.remove('visible');
                }, 3000);
            }
        });
        
        // Add keyboard support for start button
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space' && !document.getElementById('startOverlay').classList.contains('hidden')) {
                event.preventDefault();
                document.getElementById('startButton').click();
            }
        });
        
        // Handle fullscreen changes (using new fullscreen manager)
        if (window.fullscreenManager) {
            window.fullscreenManager.onEnter(() => {
                console.log('ðŸŽ® Fullscreen mode entered');
            });
            
            window.fullscreenManager.onExit(() => {
                console.log('ðŸŽ® Exited fullscreen mode - user has full control');
                // REMOVED: Auto-reenter fullscreen behavior - users should control fullscreen manually
            });
            
            window.fullscreenManager.onError((error) => {
                // Filter out empty/trusted events that don't contain useful information
                if (error && (Object.keys(error).length === 0 || (error.isTrusted && Object.keys(error).length === 1))) {
                    // Skip logging empty/trusted events that are normal browser behavior
                    return;
                }
                console.log('ðŸŽ® Fullscreen error:', error?.message || error);
            });
        }
        
        // Prevent any game initialization before start button
        // Override any auto-start behaviors
        window.autoStartDisabled = true;
        
        // Monitor game state for debugging
        setInterval(() => {
            if (gameInitialized && window.gameState) {
                console.log('Game state:', {
                    running: window.gameState.running,
                    audioReady: !!(window.audioSystem && window.audioSystem.isInitialized()),
                    playerReady: !!window.player,
                    rhythmActive: !!(window.rhythmSystem && window.rhythmSystem.isActive && window.rhythmSystem.isActive()),
                    fullscreen: !!document.fullscreenElement
                });
            }
        }, 5000);
    </script>
</body>
</html>